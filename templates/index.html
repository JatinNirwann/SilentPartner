<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SilentPartner // Intelligence</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Noto+Sans:wght@400;500;600&display=swap"
        rel="stylesheet" />

    <!-- Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Marked for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#256af4",
                        "primary-dark": "#1a4dbf",
                        "background-light": "#f5f6f8",
                        "background-dark": "#0b0d12",
                        "surface-dark": "#151b2b",
                        "surface-lighter": "#1e273b",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"],
                        "body": ["Noto Sans", "sans-serif"],
                    },
                    boxShadow: {
                        "glow": "0 0 20px rgba(37, 106, 244, 0.15)",
                        "glow-focus": "0 0 25px rgba(37, 106, 244, 0.3)",
                    },
                    animation: {
                        "pulse-slow": "pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite",
                    }
                },
            },
        }
    </script>

    <style>
        /* Base Styles */
        body {
            margin: 0;
            overflow: hidden;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #0b0d12;
        }

        ::-webkit-scrollbar-thumb {
            background: #1e273b;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #256af4;
        }

        .glass-panel {
            background: rgba(21, 27, 43, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .material-symbols-outlined.filled {
            font-variation-settings: 'FILL' 1;
        }

        .nav-item.active {
            background-color: #256af4;
            color: white;
            box-shadow: 0 0 20px rgba(37, 106, 244, 0.25);
        }

        .nav-item.active .icon {
            color: white;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: none;
            }
        }

        /* Loader */
        .loader {
            border: 2px solid rgba(37, 106, 244, 0.1);
            border-left-color: #256af4;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Dropdown Menu */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-menu {
            position: fixed;
            background: #1e273b;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            min-width: 180px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
        }

        .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-menu button {
            width: 100%;
            padding: 10px 14px;
            text-align: left;
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.15s;
        }

        .dropdown-menu button:hover {
            background: rgba(37, 106, 244, 0.1);
            color: white;
        }

        .dropdown-menu button:first-child {
            border-radius: 8px 8px 0 0;
        }

        .dropdown-menu button:last-child {
            border-radius: 0 0 8px 8px;
        }

        .dropdown-menu .divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.05);
            margin: 4px 0;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: #151b2b;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-body pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Noto Sans', monospace;
            font-size: 13px;
            line-height: 1.6;
            color: #cbd5e1;
        }
    </style>
</head>

<body class="bg-background-dark text-white font-display h-screen flex selection:bg-primary selection:text-white">

    <!-- SIDEBAR -->
    <aside
        class="w-20 md:w-72 flex flex-col border-r border-white/5 bg-[#101623] shrink-0 z-20 transition-all duration-300">
        <!-- Logo -->
        <div class="p-6 pb-4 flex flex-col">
            <h1 class="text-white text-lg font-bold tracking-widest flex items-center gap-3">
                <span class="hidden md:block">SILENT<br /><span class="text-slate-500">PARTNER</span></span>
            </h1>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 px-4 py-6 space-y-2">
            <button onclick="switchTab('tasks')" id="nav-tasks"
                class="nav-item w-full flex items-center gap-4 px-3 py-3 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition-all group">
                <span class="material-symbols-outlined icon transition-colors">grid_view</span>
                <span class="hidden md:block text-sm font-medium">Task Matrix</span>
            </button>
            <button onclick="switchTab('chat')" id="nav-chat"
                class="nav-item active w-full flex items-center gap-4 px-3 py-3 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition-all group">
                <span class="material-symbols-outlined icon transition-colors filled">chat_bubble</span>
                <span class="hidden md:block text-sm font-medium">Secure Chat</span>
            </button>
            <button onclick="switchTab('ingest')" id="nav-ingest"
                class="nav-item w-full flex items-center gap-4 px-3 py-3 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition-all group">
                <span class="material-symbols-outlined icon transition-colors">upload_file</span>
                <span class="hidden md:block text-sm font-medium">Knowledge Base</span>
            </button>
        </nav>

        <!-- Status -->
        <div class="p-4 border-t border-white/5 hidden md:block">
            <div class="flex items-center gap-2 mb-2">
                <span class="relative flex h-2 w-2">
                    <span
                        class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                </span>
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-wider">Local Node Active</p>
            </div>
            <div class="text-[10px] text-slate-600 font-mono">v2.4.1 // Encrypted</div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main
        class="flex-1 flex flex-col relative overflow-hidden bg-gradient-to-br from-background-dark to-[#0f1219] min-h-0">

        <!-- HEADER -->
        <header class="h-16 flex items-center justify-between px-6 border-b border-white/5 glass-panel shrink-0 z-10">
            <div class="flex items-center gap-3">
                <h2 class="text-sm md:text-base font-bold tracking-wider text-white" id="header-title">
                    New Chat
                </h2>
            </div>
            <div class="flex items-center gap-3">
                <div class="flex items-center px-3 py-1.5 rounded bg-surface-lighter border border-white/5 gap-2">
                    <span class="material-symbols-outlined text-emerald-400 text-[18px]">verified_user</span>
                    <span class="hidden md:block text-xs font-bold text-emerald-400 tracking-wide">ENCRYPTED</span>
                </div>
            </div>
        </header>

        <!-- VIEW: CHAT -->
        <div id="view-chat" class="view-section flex-1 flex flex-col h-full overflow-hidden relative">
            <!-- Messages -->
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth pb-32">
                <div class="flex justify-center">
                    <span
                        class="text-[10px] font-bold text-slate-600 uppercase tracking-widest bg-surface-dark px-3 py-1 rounded-full border border-white/5">Today</span>
                </div>
                <!-- Initial Message -->
                <div class="flex items-start gap-4 max-w-3xl mx-auto w-full">

                    <div class="flex flex-col gap-2 flex-1">
                        <div class="flex items-baseline gap-2">
                            <span class="text-[10px] text-slate-500">System</span>
                        </div>
                        <div
                            class="p-4 rounded-xl text-sm leading-relaxed shadow-sm font-body max-w-2xl bg-surface-lighter border border-white/5 rounded-tl-none text-slate-200">
                            Greetings. I am connected to your local knowledge base. How can I assist you?
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input -->
            <div
                class="absolute bottom-0 left-0 right-0 p-4 md:p-6 bg-gradient-to-t from-background-dark via-background-dark to-transparent z-20">
                <div class="max-w-3xl mx-auto">
                    <!-- Suggestions -->
                    <div class="flex gap-2 mb-3 overflow-x-auto pb-1 no-scrollbar">
                        <button onclick="sendSuggestion(this)"
                            class="whitespace-nowrap px-3 py-1.5 rounded-full bg-surface-lighter border border-white/5 text-xs text-slate-400 hover:text-white hover:bg-white/10 hover:border-primary/30 transition-all">Summarize
                            this document</button>
                        <button onclick="sendSuggestion(this)"
                            class="whitespace-nowrap px-3 py-1.5 rounded-full bg-surface-lighter border border-white/5 text-xs text-slate-400 hover:text-white hover:bg-white/10 hover:border-primary/30 transition-all">Find
                            expiration dates</button>
                    </div>

                    <div
                        class="relative bg-[#151b2b] rounded-2xl shadow-2xl border border-white/10 focus-within:border-primary/50 focus-within:shadow-glow transition-all duration-300 group">
                        <div class="absolute left-3 bottom-3 flex items-center gap-1">
                            <button
                                class="p-2 rounded-lg text-slate-400 hover:text-white hover:bg-white/10 transition-colors"><span
                                    class="material-symbols-outlined text-[20px]">add_circle</span></button>
                        </div>
                        <textarea id="chat-input" onkeydown="handleEnter(event)"
                            class="w-full bg-transparent text-white placeholder-slate-500 text-sm p-4 pl-14 pr-16 min-h-[60px] max-h-[120px] resize-none focus:ring-0 border-none font-body leading-relaxed outline-none"
                            placeholder="Ask SilentPartner about your documents..." rows="1"></textarea>
                        <div class="absolute right-2 bottom-2">
                            <button onclick="sendMessage()"
                                class="h-10 w-10 flex items-center justify-center rounded-xl bg-primary text-white shadow-glow hover:bg-primary-dark transition-all transform active:scale-95">
                                <span class="material-symbols-outlined text-[20px]">send</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: INGEST -->
        <div id="view-ingest" class="view-section hidden h-full p-8 overflow-y-auto">
            <div class="max-w-7xl mx-auto w-full h-full flex flex-col gap-8">
                <!-- Dropzone -->
                <div class="w-full shrink-0 h-64 flex flex-col justify-center items-center border-2 border-dashed border-white/10 rounded-2xl bg-surface-lighter/20 hover:bg-surface-lighter/40 hover:border-primary/50 transition-all group cursor-pointer relative overflow-hidden"
                    onclick="triggerUpload()">
                    <input type="file" id="file-input" hidden onchange="handleFileUpload(event)">
                    <div
                        class="absolute inset-0 bg-gradient-to-br from-primary/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                    </div>
                    <div class="text-center p-8 z-10">
                        <div
                            class="h-16 w-16 bg-surface-lighter rounded-full flex items-center justify-center mx-auto mb-4 border border-white/10 group-hover:scale-110 transition-transform shadow-glow">
                            <span class="material-symbols-outlined text-3xl text-primary">cloud_upload</span>
                        </div>
                        <h2 class="text-2xl font-bold text-white mb-2">INGEST DATA</h2>
                        <p class="text-slate-400 max-w-md mx-auto mb-6 text-sm">Drag & drop PDF files or
                            Images to expand the local intelligence memory.</p>
                        <div
                            class="flex justify-center gap-4 text-xs font-mono text-slate-500 uppercase tracking-widest">
                            <span class="flex items-center gap-2"><span
                                    class="material-symbols-outlined text-sm">picture_as_pdf</span> PDF</span>
                            <span class="flex items-center gap-2"><span
                                    class="material-symbols-outlined text-sm">view_in_ar</span> OCR</span>
                            <span class="flex items-center gap-2"><span
                                    class="material-symbols-outlined text-sm">lock</span> Private</span>
                        </div>
                    </div>
                </div>

                <!-- Memory Bank List -->
                <div class="flex-1 flex flex-col min-h-0 overflow-y-auto">
                    <div class="flex items-center justify-between mb-4 shrink-0">
                        <h3 class="text-sm font-bold text-slate-200 uppercase tracking-wider flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">memory</span> Memory Bank
                        </h3>
                        <span class="text-xs text-primary hover:text-white cursor-pointer"
                            onclick="loadDocuments()">Refresh</span>
                    </div>
                    <div id="file-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pr-2 pb-20">
                        <!-- Dynamic File List -->
                        <p class="text-xs text-slate-500 italic p-3 col-span-full text-center">Loading documents...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: TASKS -->
        <div id="view-tasks" class="view-section hidden h-full p-8 overflow-y-auto">
            <div class="max-w-6xl mx-auto w-full">
                <!-- Header -->
                <div class="flex items-end justify-between mb-8 border-b border-white/10 pb-4">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="relative flex h-2 w-2">
                                <span
                                    class="animate-ping absolute inline-flex h-full w-full rounded-full bg-primary opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-2 w-2 bg-primary"></span>
                            </span>
                            <span class="text-[10px] font-mono text-primary uppercase">System Online // Sync
                                Active</span>
                        </div>
                        <h1 class="text-4xl font-bold text-white tracking-tight">TASK_MATRIX <span
                                class="text-primary">//</span> STREAM</h1>
                        <p class="text-slate-400 mt-2 max-w-2xl">Manage document retrieval queues and intelligent agent
                            reminders.</p>
                    </div>
                    <!-- Clock could go here -->
                </div>

                <div class="p-8 bg-surface-lighter rounded-xl border border-white/5 text-center">
                    <span class="material-symbols-outlined text-4xl text-slate-600 mb-2">construction</span>
                    <h3 class="text-lg font-bold text-slate-300">Module Under Construction</h3>
                    <p class="text-slate-500 text-sm mt-1">This neural pathway is currently being forged.</p>
                </div>
            </div>
        </div>

    </main>

    <!-- Modal for Extracted Text -->
    <div id="text-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div>
                    <h3 class="text-lg font-bold text-white" id="modal-title">Extracted Text</h3>
                    <p class="text-xs text-slate-500 mt-1" id="modal-subtitle"></p>
                </div>
                <button onclick="closeModal()"
                    class="p-2 rounded-lg text-slate-400 hover:text-white hover:bg-white/10 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                <pre id="modal-text">Loading...</pre>
            </div>
        </div>
    </div>

    <script>
        // State
        const views = ['chat', 'ingest', 'tasks'];
        let isFirstMessage = true;

        // Navigation Logic
        function switchTab(viewId) {
            views.forEach(v => {
                document.getElementById(`view-${v}`).classList.add('hidden');
                document.getElementById(`nav-${v}`).classList.remove('active');
                document.getElementById(`nav-${v}`).querySelector('.icon').classList.remove('filled');
            });
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
            const activeNav = document.getElementById(`nav-${viewId}`);
            activeNav.classList.add('active');
            activeNav.querySelector('.icon').classList.add('filled');

            const titles = {
                'chat': 'New Chat',
                'ingest': 'KNOWLEDGE BASE // <span class="text-slate-400 font-normal">UPLOAD</span>',
                'tasks': 'TASK MATRIX // <span class="text-slate-400 font-normal">OVERVIEW</span>'
            };
            if (viewId === 'chat' && !isFirstMessage && document.getElementById('header-title').innerText !== 'New Chat') {
                // Keep existing title
            } else {
                document.getElementById('header-title').innerHTML = titles[viewId];
            }
        }

        // Chat Logic
        const chatContainer = document.getElementById('chat-container');
        const chatInput = document.getElementById('chat-input');

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function sendSuggestion(btn) {
            chatInput.value = btn.innerText;
            sendMessage();
        }

        async function sendMessage() {
            const text = chatInput.value.trim();
            if (!text) return;

            // Simple title update logic on first message
            if (isFirstMessage) {
                const summary = text.length > 30 ? text.substring(0, 30) + '...' : text;
                document.getElementById('header-title').innerText = summary;
                isFirstMessage = false;
            }

            appendMessage('user', text);
            chatInput.value = '';
            scrollToBottom();

            // API Call
            const loadingId = appendLoading();

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: text })
                });
                const data = await response.json();
                removeMessage(loadingId);

                if (data.response) {
                    appendMessage('ai', data.response);
                } else {
                    appendMessage('ai', "I encountered an error processing your request.");
                }
            } catch (error) {
                removeMessage(loadingId);
                appendMessage('ai', `Connection Error: ${error.message}`);
            }
        }

        function appendMessage(role, content) {
            const isUser = role === 'user';
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            let displayContent = content;
            if (role === 'ai') {
                displayContent = marked.parse(content);
            }

            const msgHTML = `
                <div class="flex items-start gap-4 max-w-3xl mx-auto w-full fade-in ${isUser ? 'justify-end' : ''}">
                    
                    <div class="flex flex-col gap-2 ${isUser ? 'items-end' : 'flex-1 min-w-0'}">
                        <div class="flex items-baseline gap-2 ${isUser ? 'flex-row-reverse' : ''}">
                            <span class="text-[10px] text-slate-500">${timestamp}</span>
                        </div>
                        <div class="p-4 rounded-xl text-sm leading-relaxed shadow-sm font-body max-w-2xl ${isUser ? 'bg-primary text-white rounded-tr-none shadow-glow' : 'bg-surface-lighter border border-white/5 rounded-tl-none text-slate-200'}">
                            ${displayContent}
                        </div>
                    </div>
                </div>
            `;
            chatContainer.insertAdjacentHTML('beforeend', msgHTML);
            scrollToBottom();
        }

        function appendLoading() {
            const id = 'loading-' + Date.now();
            const msgHTML = `
                <div id="${id}" class="flex items-start gap-4 max-w-3xl mx-auto w-full fade-in">
                    <div class="flex flex-col gap-2 flex-1 min-w-0">
                         <div class="p-4 rounded-xl text-sm leading-relaxed shadow-sm font-body max-w-2xl bg-surface-lighter border border-white/5 rounded-tl-none text-slate-200">
                            Thinking...
                        </div>
                    </div>
                </div>`;
            chatContainer.insertAdjacentHTML('beforeend', msgHTML);
            scrollToBottom();
            return id;
        }

        function removeMessage(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function scrollToBottom() {
            chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        }

        // Ingest Logic
        function triggerUpload() {
            document.getElementById('file-input').click();
        }

        async function handleFileUpload(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                const formData = new FormData();
                formData.append('file', file);

                // Show uploading UI in list
                const list = document.getElementById('file-list');
                const tempId = 'upload-' + Date.now();
                list.insertAdjacentHTML('afterbegin', `
                    <div id="${tempId}" class="p-3 rounded-lg bg-surface-lighter border border-white/5 flex items-center gap-3">
                         <div class="loader"></div>
                         <div class="flex-1 min-w-0"><p class="text-sm text-slate-200">Uploading ${file.name}...</p></div>
                    </div>
                `);

                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();

                    document.getElementById(tempId).remove();

                    if (response.ok) {
                        loadDocuments(); // Refresh list
                        switchTab('chat');
                        appendMessage('ai', `Analysis complete. I've indexed **${data.filename}**.`);
                    } else {
                        alert("Upload failed: " + data.error);
                    }
                } catch (error) {
                    document.getElementById(tempId).remove();
                    alert("Upload error: " + error.message);
                }

                e.target.value = ''; // Reset input
            }
        }

        async function loadDocuments() {
            const list = document.getElementById('file-list');
            list.innerHTML = '<div class="loader mx-auto"></div>';

            try {
                const response = await fetch('/documents');
                const data = await response.json();
                list.innerHTML = '';

                if (data.documents && data.documents.length > 0) {
                    data.documents.forEach(doc => {
                        const item = `
                            <div class="p-3 rounded-lg bg-surface-lighter border border-white/5 hover:border-primary/50 transition-all flex items-center gap-3 group fade-in relative">
                                <div class="h-10 w-10 rounded bg-blue-500/10 flex items-center justify-center text-blue-400 shrink-0">
                                    <span class="material-symbols-outlined">description</span>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-slate-200 truncate">${doc.filename}</p>
                                    <p class="text-[10px] text-emerald-400 font-bold tracking-wider">INDEXED</p>
                                </div>
                                <button onclick="showGlobalDropdown(event, ${doc.id}, '${doc.filename.replace(/'/g, "\\'")}')" class="p-2 rounded-lg text-slate-400 hover:text-white hover:bg-white/10 transition-colors opacity-0 group-hover:opacity-100">
                                    <span class="material-symbols-outlined">more_vert</span>
                                </button>
                            </div>
                        `;
                        list.insertAdjacentHTML('beforeend', item);
                    });
                } else {
                    list.innerHTML = '<p class="text-slate-500 text-sm p-4 text-center">No documents in memory.</p>';
                }
            } catch (e) {
                list.innerHTML = '<p class="text-red-400 text-sm p-4 text-center">Failed to load documents.</p>';
            }
        }

        async function deleteDoc(id, event) {
            event.stopPropagation();
            closeAllDropdowns();
            if (confirm("Delete this document from memory?")) {
                await fetch(`/documents/${id}`, { method: 'DELETE' });
                loadDocuments();
            }
        }



        function closeAllDropdowns() {
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.classList.remove('show');
            });
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', () => {
            closeAllDropdowns();
        });

        // Document Actions
        function openDocument(docId, event) {
            event.stopPropagation();
            closeAllDropdowns();
            window.open(`/documents/${docId}/file`, '_blank');
        }

        async function viewExtractedText(docId, filename, event) {
            event.stopPropagation();
            closeAllDropdowns();

            // Show modal
            const modal = document.getElementById('text-modal');
            const modalText = document.getElementById('modal-text');
            const modalTitle = document.getElementById('modal-title');
            const modalSubtitle = document.getElementById('modal-subtitle');

            modalTitle.textContent = 'Extracted Text';
            modalSubtitle.textContent = filename;
            modalText.textContent = 'Loading...';
            modal.classList.add('show');

            try {
                const response = await fetch(`/documents/${docId}/text`);
                const data = await response.json();

                if (response.ok) {
                    modalText.textContent = data.extracted_text || 'No text extracted from this document.';
                } else {
                    modalText.textContent = 'Error: ' + (data.error || 'Failed to load text');
                }
            } catch (error) {
                modalText.textContent = 'Error loading text: ' + error.message;
            }
        }

        function closeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('text-modal').classList.remove('show');
        }

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Initial Load
        loadDocuments();
    </script>

    <!-- Global Dropdown Menu -->
    <div id="global-dropdown" class="dropdown-menu">
        <button id="global-open-btn" onclick="">
            <span class="material-symbols-outlined text-[16px] align-middle mr-2">open_in_new</span>Open Document
        </button>
        <button id="global-text-btn" onclick="">
            <span class="material-symbols-outlined text-[16px] align-middle mr-2">description</span>View Extracted Text
        </button>
        <div class="h-px bg-slate-700 my-1"></div>
        <button id="global-delete-btn" onclick="" class="text-red-400 hover:text-red-300">
            <span class="material-symbols-outlined text-[16px] align-middle mr-2">delete</span>Delete
        </button>
    </div>

    <script>
        // ... (existing scripts) ... 

        let activeDocId = null;

        function showGlobalDropdown(event, docId, filename) {
            event.stopPropagation();
            event.preventDefault();

            const button = event.currentTarget;
            const dropdown = document.getElementById('global-dropdown');
            const openBtn = document.getElementById('global-open-btn');
            const textBtn = document.getElementById('global-text-btn');
            const deleteBtn = document.getElementById('global-delete-btn');

            // Set actions
            openBtn.onclick = (e) => openDocument(docId, e);
            textBtn.onclick = (e) => viewExtractedText(docId, filename, e);
            deleteBtn.onclick = (e) => deleteDoc(docId, e);

            // Position
            const rect = button.getBoundingClientRect();
            dropdown.style.top = (rect.bottom + 5) + 'px';
            dropdown.style.right = (window.innerWidth - rect.right) + 'px'; // Align right edge
            dropdown.style.left = 'auto'; // Reset left

            // Show
            closeAllDropdowns();
            dropdown.classList.add('show');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.dropdown-menu')) {
                closeAllDropdowns();
            }
        });

        // ...
    </script>
</body>

</html>